# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: Copyright (c) 2024 Rifa Achrinza
name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions: {}

jobs:
  code-lint:
    name: Code Lint
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0d381219ddf674d61a7572ddd19d7941e271515c # v2.9.0
        with:
          egress-policy: audit
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22
          cache: npm
      - name: Setup ShellCheck
        run: |-
          curl -LO https://github.com/koalaman/shellcheck/releases/download/v0.10.0/shellcheck-v0.10.0.linux.x86_64.tar.xz
          tar -xJf shellcheck-v0.10.0.linux.x86_64.tar.xz
          install -Dm 755 "shellcheck-v0.10.0/shellcheck" /usr/local/bin/shellcheck
      - name: Bootstrap dependencies
        run: npm ci
      - name: Verify code linting
        run: shellcheck start-db2.sh
  commit-lint:
    name: Commit Lint
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0d381219ddf674d61a7572ddd19d7941e271515c # v2.9.0
        with:
          egress-policy: audit
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22
          cache: npm
      - name: Bootstrap dependencies
        run: npm ci
      - name: Verify commit linting
        run: |-
          npm exec \
            --no \
            --package=commitlint \
            -- \
            commitlint \
              --from=origin/master \
              --to=HEAD \
              --verbose
  license-lint:
    name: License Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0d381219ddf674d61a7572ddd19d7941e271515c # v2.9.0
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          depth: 1
      - name: Setup REUSE Tool
        uses: fsfe/reuse-action@3ae3c6bdf1257ab19397fab11fd3312144692083 # v4.0.0
  test-shellscript:
    name: Test (Internal Shell Script)
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        db2-version:
          - 77095d4e04cf4448c0257086afcb2c166193d718dc33441da3b949f97e21efd5 # v11.5.9.0
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0d381219ddf674d61a7572ddd19d7941e271515c # v2.9.0
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          depth: 1
      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: 22
          cache: npm
      - name: Run shell script
        run: ./scripts/test.sh
  test-ghaction:
    name: Test (GitHub Action)
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        db2-version:
          - 77095d4e04cf4448c0257086afcb2c166193d718dc33441da3b949f97e21efd5 # v11.5.9.0
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0d381219ddf674d61a7572ddd19d7941e271515c # v2.9.0
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          depth: 1
      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: 22
          cache: npm
      - name: Bootstrap Dependencies
        run: npm ci --prefer-offline
      - name: Start DB2 Server
        uses: ./
        with:
          db2-version: ${{ matrix.db2-version }}
      - name: Run Tests
        run: npm test --ignore-scripts
